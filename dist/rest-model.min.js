!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.RestModel=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){"use strict";var c=a("./lib/cache"),d=a("./lib/utils"),e=b.exports=Ember.Object.extend({assignErrors:function(){},attrs:function(){return[]}.property(),arraysAreEqual:function(a,b){var c,d,e,f=a.length>=b.length?a:b,g=a.length>=b.length?b:a;for(c=0;c<f.length+1;c++)if(d=f[c],e=g[c],Ember.isArray(d)&&Ember.isArray(e)){if(!this.arraysAreEqual(d,e))return!1}else if(!Ember.isEqual(d,e))return!1;return!0},init:function(){var a=this;this.setOriginalProperties();var b=Ember.computed.apply(Ember,this.get("observableAttrs").concat(function(b,c){var d,e=a.get("attrs"),f=a.get("originalProperties");for(d=0;d<e.length;d++){b=e[d],c=a.get(b);var g=f.get(b);if(Ember.isArray(c)&&Ember.isArray(g)){if(!this.arraysAreEqual(c,g))return!0}else if(!Ember.isEqual(c,g))return!0}return!1}));Ember.defineProperty(this,"isDirty",b)},"delete":function(a){return this.submit("delete",a)},errors:function(){return[]}.property(),fetch:function(){var a=this.get("parentKeys"),b=this.getPrimaryKey();return this.constructor.find(a,b).then(function(a){return this.setProperties(a),this}.bind(this))},getParentKeys:function(){return this.parents?this.parents.map(function(a){return"number"==typeof a||"string"==typeof a?a:a.getPrimaryKey()}):[]},getPrimaryKey:function(){for(var a,b,c=this.constructor.primaryKeys,d=0;d<c.length;d++)if(a=c[d],b=this.get(a),"undefined"!=typeof b&&null!==b)return b},isPersisted:function(){var a=this.get("created_at");return"undefined"!=typeof a&&null!==a}.property("created_at"),observableAttrs:function(){return this.get("attrs").map(function(a){var b=this.get(a);return Ember.isArray(b)?a+".[]":a}.bind(this))}.property("attrs.[]"),pick:function(a){var b=this;return a.reduce(function(a,c){return a[c]=b.get(c),a},{})},revert:function(){var a=this.get("originalProperties");return this.setProperties(Object.keys(a).reduce(function(b,c){return b[c]=Ember.copy(a[c],!0),b}.bind(this),{}))},save:function(a){var b,c=this;return b=this.get("isPersisted")?"patch":"post",this.constructor.saveViaPut&&(b="put"),this.submit(b,a).then(function(){return c.setOriginalProperties()})},setOriginalProperties:function(){var a=this,b=this.get("attrs");this.set("originalProperties",Ember.keys(this).reduce(function(c,d){return-1===b.indexOf(d)?c:c.set(d,Ember.copy(a[d],!0))},Ember.Object.create()))},serialize:function(){if(void 0!==this.get("serializedProperties")&&null!==this.get("serializedProperties")){var a=this.pick(this.get("serializedProperties"));return JSON.stringify(a)}return JSON.stringify(this)},submit:function(a,b){var c=this.getParentKeys(),d=this;return"delete"===a?this.set("isDeleting",!0):this.set("isSaving",!0),new Ember.RSVP.Promise(function(e,f){d.constructor[a](c,d,b).then(function(a){d.get("errors").setObjects([]),d.setProperties(a),e(d)},function(a){d.assignErrors(a),f(a)}).finally(function(){"delete"===a?d.set("isDeleting",!1):d.set("isSaving",!1)})})}}).reopenClass({ajax:function(a){var b,d=this,e=a.method||"GET",f=this.getCacheKey(a);return a.hasOwnProperty("cache")||(a.cache=this.cache),new Ember.RSVP.Promise(function(g,h){var i;a.cache&&(b=c.getModels(d,f))&&(i=d.processResponse(b,a),g(i)),$.ajax({url:a.url,type:e,data:a.data,headers:a.headers||{},beforeSend:d.getBeforeSend(a),dataType:"json",contentType:"application/json"}).then(function(b){var h=d.processResponse(b,a);a.cache&&"GET"===e&&b&&c.update(d,f,b),i?d.updateCachedResponse(i,h):g(a.rawResponse?b:h)},function(a){delete a.then,h(a)})})},all:function(a,b){var c=this.extractPrimaryKeys(a),d=this.buildURL(c,null,b);return b=$.extend({url:d,parents:a},b),this.ajax(b)},buildURL:function(a,b,c){var d;c=c||{},d=c.withURL?c.withURL:this.url;var f=Ember.String.fmt(d.replace(/\/:[^\/]+/g,"/%@"),a),g=this.namespace||e.namespace;return g=g?"/"+g:"",Ember.isBlank(b)||(f=[f,b].join("/")),g+f},"delete":function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,b.getPrimaryKey(),c);return this.ajax({url:e,method:"DELETE",rawResponse:!0})},deserializeArray:function(a){var b=this;return $.map(a,function(a){return b.deserialize(a)})},deserialize:function(a){return this.create(a)},extractPrimaryKeys:function(a){return Ember.makeArray(a).map(function(a){return"number"==typeof a||"string"==typeof a?a:a.getPrimaryKey()})},find:function(a,b){("number"==typeof a||"string"==typeof a)&&(b=a,a=void 0);var c=this.extractPrimaryKeys(a),d=this.buildURL(c,b);return this.ajax({url:d,parents:a})},getBeforeSend:function(){return function(){}},getCacheKey:function(a){var b=a.method||"GET";return"%@: %@ - %@".fmt(this.toString(0),b,a.url)},namespace:null,objectToArray:function(a){var b=[];return Object.keys(a).forEach(function(c){b.push({key:c,value:a[c]})}),b},patch:function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,b.getPrimaryKey(),c),f=b.serialize("patch");return this.ajax({url:e,method:"PATCH",data:f,rawResponse:!0})},post:function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,null,c),f=b.serialize("post");return this.ajax({url:e,method:"POST",data:f,rawResponse:!0})},put:function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,null,c),f=b.serialize("put");return this.ajax({url:e,method:"PUT",data:f,rawResponse:!0})},primaryKeys:["id"],processResponse:function(a,b){return this.forceArray&&(a=this.objectToArray(a)),a=$.isArray(a)?this.deserializeArray(a):this.deserialize(a),b.parents&&Ember.makeArray(a).forEach(function(a){a.set("parents",Ember.makeArray(b.parents))}),a},saveViaPut:!1,updateCachedResponse:function(a,b){var c=this;$.isArray(a)?(a.forEach(function(e){return d.findMatching(e,c,b)?void 0:a.removeObject(e)}),b.forEach(function(b){var e=d.findMatching(b,c,a);return e?e.setProperties(b):a.pushObject(b)})):a.setProperties(b)}});e.V2=a("./index-v2")},{"./index-v2":2,"./lib/cache":4,"./lib/utils":5}],2:[function(a,b){"use strict";var c=a("./lib/cache-v2").create(),d=a("./lib/utils");b.exports=Ember.Object.extend({init:function(){this.setOriginalProperties();var a=Ember.computed.apply(Ember,this.get("attrNames").concat(["originalProperties"]).concat(function(){var a=this.get("attrNames"),b=this.get("originalProperties");return a.reduce(function(a,c){var e=this.get(c),f=b.get(c);return Ember.isArray(e)?d.arraysEqual(e,f)||a.push(c):Ember.isEqual(e,f)||a.push(c),a}.bind(this),[])}));Ember.defineProperty(this,"dirtyProperties",a)},attrs:function(){return[]}.property(),inFlight:Ember.computed.bool("requestPool"),isClean:Ember.computed.empty("dirtyProperties"),isDirty:Ember.computed.notEmpty("dirtyProperties"),isNew:Ember.computed.none("primaryKey"),isPersisted:Ember.computed.not("isNew"),attrNames:function(){return this.get("attrs").map(function(a){return/\.\[\]$/.test(a)?a.split(".")[0]:a})}.property("attrs"),parents:function(){var a=this.constructor.getParentKeyNames();return a.reduce(function(a,b){return a[b]=this.get(b),a}.bind(this),{})}.property().volatile(),path:function(){var a=this.get("isPersisted")?this.get("primaryKey"):null,b=this.get("parents");return this.constructor.buildPath(b,a)}.property().volatile(),primaryKey:function(){for(var a,b,c=this.constructor.primaryKeys,d=0;d<c.length;d++)if(a=c[d],b=this.get(a),!Ember.isNone(b))return b}.property().volatile(),"delete":function(a){if(Ember.isNone(this.get("primaryKey")))throw new Error("Can not delete a record with no primary key.");return this.request("deleting",function(){return a=d.extend({url:this.get("path"),type:"DELETE"},a),this.constructor.ajax(a).then(function(){return c.removeRecord(this)}.bind(this))}.bind(this))},fetch:function(a){if(Ember.isNone(this.get("primaryKey")))throw new Error("Can not fetch a record with no primary key.");return this.request("fetching",function(){return a=d.extend({url:this.get("path"),type:"GET"},a),this.constructor.ajax(a).then(function(a){return this.setProperties(a),this}.bind(this))}.bind(this))},persistToCache:function(a){return c.updateRecord(this,a)},request:function(a,b){return a="is%@".fmt(a.capitalize()),this.set(a,!0),this.incrementProperty("requestPool"),b().finally(function(){this.set(a,!1),this.decrementProperty("requestPool")}.bind(this))},revert:function(){var a=this.get("attrs");this.get("attrNames").forEach(function(b,c){var d=Ember.copy(this.get("originalProperties.%@".fmt(b)));/\.\[\]$/.test(a[c])?this.get(b).setObjects(d):this.set(b,d)}.bind(this))},save:function(a){var b=this.get("isNew")?"POST":"PATCH";return this.request("saving",function(){return a=d.extend({url:this.get("path"),type:b,data:this.serialize()},a),this.constructor.ajax(a).then(function(a){return this.persistToCache(a)}.bind(this)).then(function(a){return this.setProperties(a),this.setOriginalProperties(),this}.bind(this))}.bind(this))},setOriginalProperties:function(){var a=this.get("attrNames");this.set("originalProperties",a.reduce(function(a,b){var c=this.get(b);return a.set(b,Ember.copy(c,!0)),a}.bind(this),Ember.Object.create()))},serialize:function(){return JSON.stringify(this.toObject())},toObject:function(){return this.get("attrNames").reduce(function(a,b){var c=this.get(b);return a[b]=c,a}.bind(this),{})}}).reopenClass({typeKey:"",primaryKeys:["id"],namespace:null,base:"",cache:!1,ajax:function(a){var b={type:"GET",dataType:"json",contentType:"application/json"};return d.extend(b,a),new Ember.RSVP.Promise(function(a,c){Ember.$.ajax(b).then(function(b){b=Ember.isArray(b)?this.deserializeArray(b):this.deserialize(b),a(b)}.bind(this),function(a){delete a.then,c(a)})}.bind(this))},all:function(a,b){b=d.extend({url:this.buildPath(a),type:"GET"},b);var c={parents:a};return this.request(b,c).then(function(a){return a})},addParentsToPath:function(a,b){return Ember.$.each(a,function(a,c){var d=c;"string"!=typeof c&&"number"!=typeof c&&(d=c.get("primaryKey")),b=b.replace("/:%@".fmt(a),"/%@".fmt(d))}),b},assertHasParentKeys:function(a){this.getParentKeyNames().forEach(function(b){var c=a[b],d=c?this.getPrimaryKey(c):null;if(Ember.isNone(d))throw new Error('No primary key found for parent "%@".'.fmt(b))}.bind(this))},buildPath:function(a,b){var c="/"+this.base;return Ember.$.isPlainObject(a)||(b=a,a={}),this.assertHasParentKeys(a),c=this.addParentsToPath(a,c),Ember.isNone(b)||(c+="/"+b),Ember.isNone(this.namespace)||(c="/"+this.namespace+c),c},deserialize:function(a){return a},deserializeArray:function(a){return a.map(this.deserialize.bind(this))},find:function(a,b,c){return Ember.$.isPlainObject(a)||(c=b,b=a,a={}),c=d.extend({url:this.buildPath(a,b),type:"GET"},c),this.request(c).then(this.create.bind(this)).then(function(b){return b.setProperties(a),b})},getParentKeyNames:function(){var a=this.base.match(/\/:[^\/]+/g)||[];return a.map(function(a){return a.replace("/:","")})},getPrimaryKey:function(a){return"number"==typeof a||"string"==typeof a?a:a.get("primaryKey")},toResult:function(a,b){return b=b||{},Ember.isArray(a)?a.map(function(a){return this.create(a).setProperties(b)}.bind(this)):this.create(a).setProperties(b)},request:function(a,b){var c=this.cache&&"get"===a.type.toLowerCase();return b=d.extend({toResult:this.toResult.bind(this)},b),c?this.requestWithCache(a,b):this.ajax(a).then(function(a){var c=b.parents;return b.toResult(a,c)})},requestWithCache:function(a,b){var d;return c.getResponse(this,a.url).then(function(c){var e;return d=c,d?(e=b.toResult(d),this.ajaxAndUpdateCache(a,b,e),e):this.ajaxAndUpdateCache(a,b).then(function(a){return b.toResult(a)})}.bind(this)).then(function(a){return a})},ajaxAndUpdateCache:function(a,b,d){var e=b.parents;return this.ajax(a).then(function(b){return c.setResponse(this,a.url,b)}.bind(this)).then(function(a){return a=b.toResult(a,e),d?Ember.isArray(a)?this.updateCachedArray(d,a):this.updateCachedObject(d,a):a}.bind(this))},updateCachedArray:function(a,b){var c=d.findNotIn(b,a,this),e=d.findNotIn(a,b,this),f=d.findIn(a,b,this);return a.pushObjects(c),a.removeObjects(e),f.forEach(function(a){if(!a.get("isDirty")){var c=d.findMatching(a,this,b);c=this.getUpdatableProperties(c),a.setProperties(c),a.setOriginalProperties()}}.bind(this)),a},updateCachedObject:function(a,b){return a.get("isDirty")?void 0:(b=this.getUpdatableProperties(b),a.setProperties(b),a.setOriginalProperties(),a)},getUpdatableProperties:function(a){var b=Ember.keys(a).filter(function(a){return-1===["originalProperties","dirtyProperties"].indexOf(a)});return a.getProperties(b)}})},{"./lib/cache-v2":3,"./lib/utils":5}],3:[function(a,b){"use strict";b.exports=Ember.Object.extend({getResponse:function(a,b){return this.getItem(b).then(function(b){return Ember.isArray(b)?this.getArrayResponse(a,b):this.getItemResponse(a,b)}.bind(this))},getArrayResponse:function(a,b){return Ember.RSVP.all(b.map(function(b){var c=this.getCacheKey(a.typeKey,b);return this.getItem(c)}.bind(this))).then(function(a){return a.compact()})},getItemResponse:function(a,b){var c=this.getCacheKey(a.typeKey,b);return this.getItem(c)},setResponse:function(a,b,c){return Ember.isArray(c)?this.setArrayResponse(a,b,c):this.setItemResponse(a,b,c)},setArrayResponse:function(a,b,c){var d=a.primaryKeys[0],e=c.mapBy(d);return Ember.RSVP.all([this.setItem(b,e),c.map(function(b){var c=this.getCacheKey(a.typeKey,b[d]);return this.putItem(c,b)}.bind(this))]).then(function(){return c})},setItemResponse:function(a,b,c){var d=a.primaryKeys[0],e=c[d],f=this.getCacheKey(a.typeKey,e);return Ember.RSVP.all([this.putItem(f,c),this.setItem(b,e)]).then(function(){return c})},removeRecord:function(a){var b=a.constructor.typeKey,c=a.get(a.constructor.primaryKeys[0]),d=this.getCacheKey(b,c);return this.removeItem(d)},updateRecord:function(a,b){var c=a.constructor.primaryKeys[0],d=a.get(c)||b[c],e=this.getCacheKey(a.constructor.typeKey,d);return this.putItem(e,b)},getCacheKey:function(a,b){return"%@: %@".fmt(a,b)},getItem:function(a){return new Ember.RSVP.Promise(function(b){var c=localStorage.getItem(a)||null;b(JSON.parse(c))})},putItem:function(a,b){return this.getItem(a).then(function(c){if(c){for(var d in b)c[d]=b[d];return this.setItem(a,c)}return this.setItem(a,b)}.bind(this))},setItem:function(a,b){return new Ember.RSVP.Promise(function(c){var d=JSON.stringify(b);localStorage.setItem(a,d),c(b)})},removeItem:function(a){return new Ember.RSVP.Promise(function(b){localStorage.removeItem(a),b()})}})},{}],4:[function(a,b,c){"use strict";function d(a,b,c){var d=e.findMatching(a,b,c),f=c.indexOf(d);d?c[f]=a:c.push(a)}var e=a("./utils");c.get=function(a){var b=localStorage.getItem(a)||null;return JSON.parse(b)},c.set=function(a,b){var c=JSON.stringify(b);return localStorage.setItem(a,c)},c.getModels=function(a,b){var c=this.get(a),d=a.primaryKeys[0],e=this.get(b);return c?$.isArray(e)?c.filter(function(a){return e.contains(a[d])}):c.find(function(a){return a[d]===e}):null},c.update=function(a,b,c){var d,e=a.primaryKeys[0];this.updateClassStore(a,c),d=$.isArray(c)?c.map(function(a){return a[e]}):c[e],this.set(b,d)},c.updateClassStore=function(a,b){var c=this.get(a.toString())||[];return $.isArray(b)?b.forEach(function(b){d(b,a,c)}):d(b,a,c),this.set(a.toString(),c),c}},{"./utils":5}],5:[function(a,b,c){"use strict";c.arraysEqual=function(a,b){if(a.length!==b.length)return!1;for(var c,d,e;e<a.length;e++)if(c=a[e],d=b[e],!Ember.isEqual(c,d))return!1;return!0},c.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},c.findMatching=function(a,b,c){var d=b.primaryKeys[0];return c.find(function(b){return Ember.get(a,d)===Ember.get(b,d)})},c.findIn=function(a,b,c){return a.reduce(function(a,d){var e=this.findMatching(d,c,b);return e&&a.push(d),a}.bind(this),[])},c.findNotIn=function(a,b,c){return a.reduce(function(a,d){var e=this.findMatching(d,c,b);return e||a.push(d),a}.bind(this),[])}},{}]},{},[1])(1)});